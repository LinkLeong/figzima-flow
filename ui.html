<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Zima NAS Plugin</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 12px;
            background: #ffffff;
            color: #333;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 16px;
            border-bottom: 1px solid #e5e5e5;
            background: #f8f9fa;
        }

        .header h2 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1a1a1a;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-indicator.connected {
            background: #28a745;
        }

        .path-nav {
            padding: 12px 16px;
            background: #f1f3f4;
            border-bottom: 1px solid #e5e5e5;
            font-size: 11px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .path-nav button {
            background: none;
            border: none;
            color: #0066cc;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 2px;
        }

        .path-nav button:hover {
            background: #e3f2fd;
        }

        .toolbar {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: #ffffff;
            color: #374151;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .btn.primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .btn.primary:hover {
            background: #2563eb;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .file-browser {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .file-list {
            list-style: none;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            gap: 8px;
        }

        .file-item:hover {
            background: #f1f3f4;
        }

        .file-item.selected {
            background: #e3f2fd;
            color: #1976d2;
        }

        .file-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-meta {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
        }

        .loading {
            text-align: center;
            padding: 32px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 32px;
            color: #dc3545;
            background: #fff5f5;
            margin: 16px;
            border-radius: 4px;
            border: 1px solid #fed7d7;
        }

        .empty {
            text-align: center;
            padding: 32px;
            color: #666;
        }

        .footer {
            padding: 12px 16px;
            border-top: 1px solid #e5e5e5;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selected-info {
            font-size: 11px;
            color: #666;
        }

        .login-panel {
            padding: 16px;
            border-bottom: 1px solid #e5e5e5;
            background: #f8f9fa;
        }

        .config-section h3 {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #1a1a1a;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 4px;
            color: #374151;
        }

        .form-group input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 11px;
            background: white;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .main-content {
            display: none;
        }

        .main-content.show {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>FigZima Flow</h2>
        <div class="connection-status">
            <div class="status-indicator" id="statusIndicator"></div>
            <span id="statusText">Not Connected</span>
        </div>
    </div>

    <!-- Login Configuration Panel -->
    <div class="login-panel" id="loginPanel" style="display: none;">
        <div class="config-section">
            <h3>NAS Server Configuration</h3>
            <div class="form-group">
                <label>Server Address:</label>
                <input type="text" id="serverUrl" value="" placeholder="https://your-nas-ip:port">
            </div>
            <div class="form-group">
                <label>Username:</label>
                <input type="text" id="username" value="" placeholder="Username">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="password" value="" placeholder="Password">
            </div>
            <div class="form-actions">
                <button class="btn primary" id="loginBtn" onclick="performLogin()">ğŸ” Login</button>
                <button class="btn" id="toggleConfigBtn" onclick="toggleConfig()" style="display: none;">âš™ï¸ Settings</button>
            </div>
            <div class="help-text" style="margin-top: 12px; font-size: 10px; color: #666;">
                <strong>Network Connection:</strong><br>
                â€¢ Plugin will automatically try HTTP and HTTPS connections<br>
                â€¢ If both fail, please check if NAS server is running<br>
                â€¢ Ensure network connection is stable
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content show" id="mainContent">
        <div class="path-nav" id="pathNav">
            <button onclick="navigateToPath('/')" title="Root Directory">ğŸ </button>
            <span>/</span>
        </div>

        <div class="toolbar">
            <button class="btn" id="refreshBtn" onclick="refreshFiles()">ğŸ”„ Refresh</button>
            <button class="btn" id="uploadBtn" onclick="uploadToNAS()">ğŸ“¤ Export to NAS</button>
            <button class="btn" onclick="logout()">ğŸšª Logout</button>
        </div>

        <div class="file-browser">
            <div class="loading" id="loadingIndicator">Loading file list...</div>
            <div class="error" id="errorMessage" style="display: none;"></div>
            <ul class="file-list" id="fileList" style="display: none;"></ul>
            <div class="empty" id="emptyMessage" style="display: none;">This folder is empty</div>
        </div>

        <div class="footer">
            <div class="selected-info" id="selectedInfo">Double-click file to import, double-click folder to enter</div>
            <button class="btn" onclick="closePlugin()">Close</button>
        </div>
    </div>

<script>
// å…¨å±€çŠ¶æ€
let currentPath = '/media/ZimaOS-HD/Downloads';
let selectedFile = null;
let fileList = [];
let isLoggedIn = false;

// NASé…ç½® - ç°åœ¨é€šè¿‡ç™»å½•è·å–
let NAS_CONFIG = {
    baseUrl: '',
    token: ''
};

// DOMå…ƒç´ 
const statusIndicator = document.getElementById('statusIndicator');
const statusText = document.getElementById('statusText');
const pathNav = document.getElementById('pathNav');
const loadingIndicator = document.getElementById('loadingIndicator');
const errorMessage = document.getElementById('errorMessage');
const fileListElement = document.getElementById('fileList');
const emptyMessage = document.getElementById('emptyMessage');
const selectedInfo = document.getElementById('selectedInfo');
const refreshBtn = document.getElementById('refreshBtn');
const uploadBtn = document.getElementById('uploadBtn');
const downloadBtn = document.getElementById('downloadBtn');

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // æ’ä»¶å¯åŠ¨æ—¶å…ˆæ˜¾ç¤ºæ–‡ä»¶ç®¡ç†ç•Œé¢
    console.log('Plugin loaded, showing file manager');
    showMainContent();
    // å°è¯•åŠ è½½æ–‡ä»¶åˆ—è¡¨ï¼Œå¦‚æœå¤±è´¥ä¼šè‡ªåŠ¨æ˜¾ç¤ºç™»å½•ç•Œé¢
    loadFiles(currentPath);
});

// æ‰§è¡Œç™»å½•
function performLogin() {
    const serverUrl = document.getElementById('serverUrl').value.trim();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();

    if (!serverUrl || !username || !password) {
        showNotification('Please fill in complete login information', 'warning');
        return;
    }

    // æ£€æŸ¥åè®®
    if (serverUrl.startsWith('http://')) {
        showNotification('HTTP protocol detected, try HTTPS or allow insecure content if connection fails', 'warning');
    }

    const loginBtn = document.getElementById('loginBtn');
    loginBtn.disabled = true;
    loginBtn.textContent = 'ğŸ”„ Logging in...';

    // å‘é€ç™»å½•è¯·æ±‚åˆ°ä¸»ä»£ç å¤„ç†
    parent.postMessage({
        pluginMessage: {
            type: 'login',
            serverUrl: serverUrl,
            username: username,
            password: password
        }
    }, '*');

    // æ·»åŠ è¶…æ—¶é‡ç½®æœºåˆ¶ï¼Œé˜²æ­¢æŒ‰é’®å¡ä½
    setTimeout(() => {
        if (loginBtn.disabled && loginBtn.textContent === 'ğŸ”„ Logging in...') {
            console.log('Login timeout, resetting button');
            loginBtn.disabled = false;
            loginBtn.textContent = 'ğŸ” Login';
            showNotification('Login timeout, please try again', 'warning');
        }
    }, 30000); // 30ç§’è¶…æ—¶
}

// æ˜¾ç¤ºä¸»è¦å†…å®¹åŒºåŸŸ
function showMainContent() {
    console.log('Showing main content area');
    const loginPanel = document.getElementById('loginPanel');
    const mainContent = document.getElementById('mainContent');
    const toggleBtn = document.getElementById('toggleConfigBtn');

    if (loginPanel) loginPanel.style.display = 'none';
    if (mainContent) mainContent.classList.add('show');
    if (toggleBtn) toggleBtn.style.display = 'inline-block';

    console.log('Main content displayed');
}

// æ˜¾ç¤ºç™»å½•é¢æ¿
function showLoginPanel() {
    console.log('Showing login panel');
    const loginPanel = document.getElementById('loginPanel');
    const mainContent = document.getElementById('mainContent');
    const toggleBtn = document.getElementById('toggleConfigBtn');

    if (loginPanel) loginPanel.style.display = 'block';
    if (mainContent) mainContent.classList.remove('show');
    if (toggleBtn) toggleBtn.style.display = 'none';
    updateConnectionStatus(false);

    console.log('Login panel displayed');
}

// åˆ‡æ¢é…ç½®é¢æ¿
function toggleConfig() {
    const loginPanel = document.getElementById('loginPanel');
    const mainContent = document.getElementById('mainContent');

    if (loginPanel.style.display === 'none') {
        loginPanel.style.display = 'block';
        mainContent.classList.remove('show');
    } else {
        loginPanel.style.display = 'none';
        mainContent.classList.add('show');
    }
}

// å¤„ç†ç™»å½•æˆåŠŸï¼ˆåŒ…æ‹¬è‡ªåŠ¨ç™»å½•ï¼‰
function handleLoginSuccess(data, message) {
    NAS_CONFIG.baseUrl = data.baseUrl;
    NAS_CONFIG.token = data.token;

    isLoggedIn = true;
    showNotification(message, 'success');
    showMainContent();
    loadFiles(currentPath);

    // é‡ç½®ç™»å½•æŒ‰é’®
    const loginBtn = document.getElementById('loginBtn');
    if (loginBtn) {
        loginBtn.disabled = false;
        loginBtn.textContent = 'ğŸ” Login';
    }

    // ç¡®ä¿å¯¼å‡ºæŒ‰é’®æ˜¯å¯ç”¨çš„
    const uploadBtn = document.getElementById('uploadBtn');
    if (uploadBtn) {
        uploadBtn.disabled = false;
    }

    // å¦‚æœæœ‰ç”¨æˆ·åï¼Œæ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š
    if (data.username) {
        const statusText = document.getElementById('statusText');
        if (statusText) {
            statusText.textContent = `Connected (${data.username})`;
        }
    }
}

// ç™»å‡º
function logout() {
    // å‘é€ç™»å‡ºè¯·æ±‚åˆ°ä¸»ä»£ç 
    parent.postMessage({
        pluginMessage: {
            type: 'logout'
        }
    }, '*');

    // ç«‹å³é‡ç½®UIçŠ¶æ€
    isLoggedIn = false;
    NAS_CONFIG.token = '';
    NAS_CONFIG.baseUrl = '';

    document.getElementById('loginPanel').style.display = 'block';
    document.getElementById('mainContent').classList.remove('show');
    document.getElementById('toggleConfigBtn').style.display = 'none';
    updateConnectionStatus(false);

    // ç¦ç”¨å¯¼å‡ºæŒ‰é’®
    const uploadBtn = document.getElementById('uploadBtn');
    if (uploadBtn) {
        uploadBtn.disabled = true;
    }

    // é‡ç½®çŠ¶æ€æ–‡æœ¬
    const statusText = document.getElementById('statusText');
    if (statusText) {
        statusText.textContent = 'Not Connected';
    }
}



// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
function showLoading() {
    loadingIndicator.style.display = 'block';
    errorMessage.style.display = 'none';
    fileListElement.style.display = 'none';
    emptyMessage.style.display = 'none';
}

// æ˜¾ç¤ºé”™è¯¯
function showError(message) {
    loadingIndicator.style.display = 'none';
    errorMessage.style.display = 'block';
    errorMessage.textContent = message;
    fileListElement.style.display = 'none';
    emptyMessage.style.display = 'none';
    updateConnectionStatus(false);
}

// æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
function showFileList() {
    loadingIndicator.style.display = 'none';
    errorMessage.style.display = 'none';

    if (fileList.length === 0) {
        fileListElement.style.display = 'none';
        emptyMessage.style.display = 'block';
    } else {
        fileListElement.style.display = 'block';
        emptyMessage.style.display = 'none';
    }
    updateConnectionStatus(true);
}

// æ›´æ–°è¿æ¥çŠ¶æ€
function updateConnectionStatus(connected) {
    if (connected) {
        statusIndicator.classList.add('connected');
        statusText.textContent = 'Connected to NAS';
    } else {
        statusIndicator.classList.remove('connected');
        statusText.textContent = 'Connection Failed';
    }
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(timestamp) {
    const date = new Date(timestamp * 1000);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

// è·å–æ–‡ä»¶å›¾æ ‡
function getFileIcon(fileName, isDir) {
    if (isDir) return 'ğŸ“';

    const ext = fileName.split('.').pop().toLowerCase();
    const iconMap = {
        'png': 'ğŸ–¼ï¸', 'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸', 'svg': 'ğŸ–¼ï¸',
        'pdf': 'ğŸ“„', 'doc': 'ğŸ“„', 'docx': 'ğŸ“„', 'txt': 'ğŸ“„',
        'zip': 'ğŸ“¦', 'rar': 'ğŸ“¦', '7z': 'ğŸ“¦',
        'mp4': 'ğŸ¬', 'avi': 'ğŸ¬', 'mov': 'ğŸ¬',
        'mp3': 'ğŸµ', 'wav': 'ğŸµ', 'flac': 'ğŸµ',
        'json': 'ğŸ“‹', 'figma': 'ğŸ¨', 'sketch': 'ğŸ¨'
    };

    return iconMap[ext] || 'ğŸ“„';
}

// åŠ è½½æ–‡ä»¶åˆ—è¡¨
async function loadFiles(path) {
    if (!NAS_CONFIG.token) {
        console.log('No token found, showing login panel');
        showLoginPanel();
        return;
    }

    showLoading();

    try {
        const url = `${NAS_CONFIG.baseUrl}/v2_1/files/file?path=${encodeURIComponent(path)}&index=0&size=10000&sfz=true&sort=name&direction=asc`;

        const response = await fetch(url, {
            headers: {
                'Authorization': NAS_CONFIG.token
            }
        });

        if (!response.ok) {
            if (response.status === 401) {
                // Tokenè¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•
                logout();
                throw new Error('Login expired, please login again');
            }
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        fileList = data.content || [];
        currentPath = path;

        renderFileList();
        updatePathNavigation();
        showFileList();

    } catch (error) {
        console.error('Failed to load files:', error);
        showError('Unable to connect to NAS server: ' + error.message);
    }
}

// æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
function renderFileList() {
    fileListElement.innerHTML = '';

    fileList.forEach((file, index) => {
        const li = document.createElement('li');
        li.className = 'file-item';

        // åŒå‡»äº‹ä»¶å¤„ç†
        li.ondblclick = () => {
            if (file.is_dir) {
                // åŒå‡»æ–‡ä»¶å¤¹ï¼šè¿›å…¥æ–‡ä»¶å¤¹
                navigateToPath(file.path);
            } else {
                // åŒå‡»æ–‡ä»¶ï¼šå¯¼å…¥åˆ°Figma
                importFileToFigma(file);
            }
        };

        // å•å‡»äº‹ä»¶ï¼šä»…ç”¨äºè§†è§‰åé¦ˆ
        li.onclick = () => {
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('selected');
            });
            // é€‰æ‹©å½“å‰é¡¹
            li.classList.add('selected');
            selectedFile = file;

            // æ›´æ–°é€‰æ‹©ä¿¡æ¯
            if (file.is_dir) {
                selectedInfo.textContent = `Selected folder: ${file.name} (double-click to enter)`;
            } else {
                selectedInfo.textContent = `Selected file: ${file.name} (double-click to import)`;
            }
        };

        li.innerHTML = `
            <div class="file-icon">${getFileIcon(file.name, file.is_dir)}</div>
            <div class="file-info">
                <div class="file-name">${file.name}</div>
                <div class="file-meta">
                    ${file.is_dir ? 'Folder' : formatFileSize(file.size)} â€¢ ${formatDate(file.modified)}
                </div>
            </div>
        `;

        fileListElement.appendChild(li);
    });
}

// æ›´æ–°é€‰æ‹©ä¿¡æ¯æ˜¾ç¤º
function updateSelectionInfo() {
    if (selectedFile) {
        if (selectedFile.is_dir) {
            selectedInfo.textContent = `Selected folder: ${selectedFile.name} (double-click to enter)`;
        } else {
            selectedInfo.textContent = `Selected file: ${selectedFile.name} (double-click to import)`;
        }
    } else {
        selectedInfo.textContent = 'Double-click file to import, double-click folder to enter';
    }
}

// æ›´æ–°è·¯å¾„å¯¼èˆª
function updatePathNavigation() {
    const pathParts = currentPath.split('/').filter(part => part);
    let pathHtml = '<button onclick="navigateToPath(\'/\')" title="æ ¹ç›®å½•">ğŸ </button>';

    let buildPath = '';
    pathParts.forEach((part, index) => {
        buildPath += '/' + part;
        pathHtml += ` <span>/</span> <button onclick="navigateToPath('${buildPath}')">${part}</button>`;
    });

    pathNav.innerHTML = pathHtml;
}

// å¯¼èˆªåˆ°æŒ‡å®šè·¯å¾„
function navigateToPath(path) {
    if (path !== currentPath) {
        loadFiles(path);
    }
}

// åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
function refreshFiles() {
    loadFiles(currentPath);
}

// å¯¼å‡ºåˆ°NAS
function uploadToNAS() {
    console.log('Export to NAS button clicked');

    // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
    if (!NAS_CONFIG.token) {
        console.log('Not logged in, showing warning');
        showNotification('Please login first', 'warning');
        return;
    }

    console.log('Logged in, current config:', NAS_CONFIG);

    // ç›´æ¥ä½¿ç”¨å½“å‰è·¯å¾„ï¼Œä¸å†ä½¿ç”¨prompt
    const targetPath = currentPath;
    console.log('Using current path as target:', targetPath);

    showNotification('Exporting selected content to NAS...', 'info');

    const message = {
        pluginMessage: {
            type: 'export-to-nas',
            path: targetPath,
            nasConfig: NAS_CONFIG
        }
    };

    console.log('Sending export message to main code:', message);
    parent.postMessage(message, '*');
}

// å¯¼å…¥æ–‡ä»¶åˆ°Figmaï¼ˆåŒå‡»è§¦å‘ï¼‰
function importFileToFigma(file) {
    if (file.is_dir) {
        showNotification('Cannot import folder', 'warning');
        return;
    }

    // æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ”¯æŒ
    const supportedFormats = ['png', 'jpg', 'jpeg', 'gif', 'svg', 'json'];
    const fileExtension = file.name.split('.').pop()?.toLowerCase();

    if (!supportedFormats.includes(fileExtension)) {
        showNotification(`Unsupported file format: ${fileExtension}`, 'warning');
        return;
    }

    showNotification(`Importing ${file.name}...`, 'info');

    parent.postMessage({
        pluginMessage: {
            type: 'import-from-nas',
            file: file,
            nasConfig: NAS_CONFIG
        }
    }, '*');
}

// å…³é—­æ’ä»¶
function closePlugin() {
    parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
}

// æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
function showNotification(message, type = 'info') {
    // åˆ›å»ºé€šçŸ¥å…ƒç´ 
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 16px;
        right: 16px;
        padding: 12px 16px;
        border-radius: 4px;
        color: white;
        font-size: 12px;
        z-index: 1000;
        max-width: 300px;
        word-wrap: break-word;
        animation: slideIn 0.3s ease-out;
    `;

    // æ ¹æ®ç±»å‹è®¾ç½®èƒŒæ™¯è‰²
    switch (type) {
        case 'success':
            notification.style.backgroundColor = '#28a745';
            break;
        case 'error':
            notification.style.backgroundColor = '#dc3545';
            break;
        case 'warning':
            notification.style.backgroundColor = '#ffc107';
            notification.style.color = '#212529';
            break;
        default:
            notification.style.backgroundColor = '#17a2b8';
    }

    notification.textContent = message;
    document.body.appendChild(notification);

    // 3ç§’åè‡ªåŠ¨ç§»é™¤
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// æ·»åŠ CSSåŠ¨ç”»
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// ç›‘å¬æ¥è‡ªä¸»ä»£ç çš„æ¶ˆæ¯
window.addEventListener('message', (event) => {
    console.log('UIæ”¶åˆ°æ¶ˆæ¯:', event);
    console.log('æ¶ˆæ¯æ•°æ®:', event.data);

    // ä¿®å¤æ¶ˆæ¯è§£æ - å¤„ç†åŒé‡åµŒå¥—çš„pluginMessage
    const outerMessage = event.data.pluginMessage;
    if (!outerMessage) {
        console.log('æ²¡æœ‰pluginMessage');
        return;
    }

    console.log('pluginMessageå†…å®¹:', outerMessage);

    // æ£€æŸ¥æ˜¯å¦æœ‰åµŒå¥—çš„pluginMessage
    const actualMessage = outerMessage.pluginMessage || outerMessage;
    console.log('å®é™…æ¶ˆæ¯å†…å®¹:', actualMessage);

    const { type, error, data } = actualMessage;
    console.log('è§£æçš„æ¶ˆæ¯:', { type, error, data });

    switch (type) {
        case 'login-success': {
            // ç™»å½•æˆåŠŸ
            console.log('Received login success message:', data);
            handleLoginSuccess(data, 'Login successful!');
            break;
        }

        case 'auto-login-success': {
            // è‡ªåŠ¨ç™»å½•æˆåŠŸ
            console.log('Received auto-login success message:', data);
            handleLoginSuccess(data, 'Welcome back! Auto-logged in');
            break;
        }

        case 'login-error': {
            console.log('Received login error message:', error);
            showNotification('Login failed: ' + (error || 'Unknown error'), 'error');

            // é‡ç½®ç™»å½•æŒ‰é’®
            const loginBtnError = document.getElementById('loginBtn');
            if (loginBtnError) {
                loginBtnError.disabled = false;
                loginBtnError.textContent = 'ğŸ” Login';
            }
            break;
        }

        case 'logout-success': {
            console.log('Logout successful');
            showNotification('Safely logged out', 'info');
            break;
        }

        case 'export-success':
            showNotification('File exported successfully!', 'success');
            refreshFiles(); // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨ä»¥æ˜¾ç¤ºæ–°ä¸Šä¼ çš„æ–‡ä»¶
            break;

        case 'export-error':
            showNotification('Export failed: ' + (error || 'Unknown error'), 'error');
            break;

        case 'import-success':
            showNotification('File imported successfully!', 'success');
            break;

        case 'import-error':
            showNotification('Import failed: ' + (error || 'Unknown error'), 'error');
            break;

        case 'no-selection':
            showNotification('Please select layers or pages to export first', 'warning');
            break;

        case 'network-error':
            showNotification('Network connection failed, please check NAS server connection', 'error');
            updateConnectionStatus(false);
            showLoginPanel();
            break;

        case 'auth-error':
            showNotification('Authentication failed, please login again', 'error');
            updateConnectionStatus(false);
            showLoginPanel();
            break;
    }
});

</script>
</body>
</html>
